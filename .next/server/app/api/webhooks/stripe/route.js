"use strict";(()=>{var e={};e.id=798,e.ids=[798],e.modules={3524:e=>{e.exports=require("@prisma/client")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6113:e=>{e.exports=require("crypto")},6944:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>w,originalPathname:()=>y,patchFetch:()=>v,requestAsyncStorage:()=>g,routeModule:()=>f,serverHooks:()=>b,staticGenerationAsyncStorage:()=>m,staticGenerationBailout:()=>k});var a={};r.r(a),r.d(a,{POST:()=>p});var n=r(5419),i=r(9108),o=r(9678),s=r(8070),d=r(6113),u=r.n(d);let c=new Set;async function p(e){try{let t=process.env.STRIPE_WEBHOOK_SECRET;if(!t)return s.Z.json({error:"Webhook secret not configured"},{status:500});if(!e.url.startsWith("https://"))return s.Z.json({error:"HTTPS required in production"},{status:400});let r=await e.text(),a=e.headers.get("stripe-signature");if(!a)return s.Z.json({error:"Missing stripe-signature header"},{status:400});if(!function(e,t,r){try{let a,n;for(let e of t.split(",")){let[t,r]=e.split("=");"t"===t&&(a=r),"v1"===t&&(n=r)}if(!a||!n)return!1;let i=`${a}.${e}`,o=u().createHmac("sha256",r).update(i,"utf8").digest("hex");return u().timingSafeEqual(Buffer.from(n,"hex"),Buffer.from(o,"hex"))}catch(e){return!1}}(r,a,t))return s.Z.json({error:"Invalid signature"},{status:400});let n=JSON.parse(r);switch(n.type){case"payment_intent.succeeded":{let e=n.data?.object;if(!e?.metadata?.bookingId)return s.Z.json({error:"Missing booking ID"},{status:400});let t=c.has(n.id);try{await l(e)}catch(e){if(String(e?.message||"").includes("Database connection failed"))return s.Z.json({error:"Internal server error"},{status:500});throw e}return c.add(n.id),s.Z.json({received:!0,alreadyProcessed:t})}case"payment_intent.payment_failed":{let e=n.data?.object;if(!e?.metadata?.bookingId)return s.Z.json({error:"Missing booking ID"},{status:400});let t=c.has(n.id);try{await h(e)}catch(e){if(String(e?.message||"").includes("Database connection failed"))return s.Z.json({error:"Internal server error"},{status:500});throw e}return c.add(n.id),s.Z.json({received:!0,alreadyProcessed:t})}default:{let e={received:!0,ignored:!0,alreadyProcessed:c.has(n.id)};return c.add(n.id),s.Z.json(e)}}}catch(e){if(console.error("Webhook error:",e),e instanceof SyntaxError)return s.Z.json({error:"Invalid JSON"},{status:400});return s.Z.json({error:"Internal server error"},{status:500})}}async function l(e){let t=e.metadata?.bookingId;if(!t)throw Error("Missing booking ID in payment intent metadata");{let{prisma:a}=await r.e(494).then(r.bind(r,1494));await a.booking.update({where:{id:t},data:{stripePaymentStatus:"SUCCEEDED",stripePaymentIntentId:e.id}});let n=await a.booking.findUnique({where:{id:t},include:{event:!0}});n&&await a.event.update({where:{id:n.eventId},data:{status:"CONFIRMED"}})}console.log(`Payment succeeded for booking ${t}`)}async function h(e){let t=e.metadata?.bookingId;if(!t)throw Error("Missing booking ID in payment intent metadata");{let{prisma:a}=await r.e(494).then(r.bind(r,1494));await a.booking.update({where:{id:t},data:{stripePaymentStatus:"FAILED",stripePaymentIntentId:e.id}})}console.log(`Payment failed for booking ${t}`)}let f=new n.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/webhooks/stripe/route",pathname:"/api/webhooks/stripe",filename:"route",bundlePath:"app/api/webhooks/stripe/route"},resolvedPagePath:"C:\\Users\\Owner\\Desktop\\splash\\src\\app\\api\\webhooks\\stripe\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:g,staticGenerationAsyncStorage:m,serverHooks:b,headerHooks:w,staticGenerationBailout:k}=f,y="/api/webhooks/stripe/route";function v(){return(0,o.patchFetch)({serverHooks:b,staticGenerationAsyncStorage:m})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[638,206],()=>r(6944));module.exports=a})();